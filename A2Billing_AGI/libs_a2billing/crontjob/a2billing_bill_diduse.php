#!/usr/bin/php -q
<?php 
/***************************************************************************
 *            a2billing_bill_diduse.php
 *
 *  Fri Oct 28 11:51:08 2005
 *  Copyright  2005  User
 *  ADD THIS SCRIPT IN A CRONTAB JOB
 *
	crontab -e
	0 12 * * * php /var/lib/asterisk/agi-bin/libs_a2billing/a2billing_batch_process.php
	
	
	# crontab -l
	# DO NOT EDIT THIS FILE - edit the master and reinstall.
	# (/tmp/crontab.9543 installed on Fri Oct 28 04:44:10 2005)
	# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
	0 12 * * * php /var/lib/asterisk/agi-bin/libs_a2billing/a2billing_batch_process.php
****************************************************************************/
	set_time_limit(0);
	error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));
	//dl("pgsql.so"); // remove "extension= pgsql.so !	
	
	include (dirname(__FILE__)."/../db_php_lib/Class.Table.php");
	include (dirname(__FILE__)."/../Class.A2Billing.php");
	
	
	
		
	
    $verbose_level=0;
	
	$groupcard=5000;
	
	function write_log($output, $tobuffer = 1){
			
			$string_log = "[".date("d/m/Y H:i:s")."]:$output\n";
			error_log ($string_log, 3, BATCH_LOG_FILE);
						
	}
	
	write_log("[#### BATCH BEGIN ####]");
	
	
	$A2B = new A2Billing();
	$A2B -> load_conf($agi, NULL, 0, $idconfig);
	
	if (!$A2B -> DbConnect()){				
				echo "[Cannot connect to the database]\n";
				write_log("[Cannot connect to the database]");
				exit;						
	}
	//$A2B -> DBHandle
	$instance_table = new Table();
	
	
	// CHECK NUMBER OF CARD
	$QUERY = 'SELECT count(*) FROM cc_card WHERE runservice=1';

	$result = $instance_table -> SQLExec ($A2B -> DBHandle, $QUERY);
	$nb_card = $result[0][0];
	$nbpagemax=(intval($nb_card/$groupcard));
	if ($verbose_level>=1) echo "===> NB_CARD : $nb_card - NBPAGEMAX:$nbpagemax\n";
	
	if (!($nb_card>0)){
			if ($verbose_level>=1) echo "[No card to run the Recurring service]\n";
			write_log("[No card to run the Recurring service]");
			exit();
	}
	
	
	
	
	// CHECK THE SERVICES
	$QUERY = 'SELECT id, name, amount, period, rule, daynumber, stopmode, maxnumbercycle, status, numberofrun, datecreate, 
	datelastrun, emailreport, totalcredit,totalcardperform FROM cc_service WHERE status=1';

	$result = $instance_table -> SQLExec ($A2B -> DBHandle, $QUERY);
	
	if ($verbose_level>=1) print_r ($result);
	
	if( !is_array($result)) {
			echo "[No Recurring service to run]\n";
			write_log("[ No Recurring service to run]");
			exit();
    }
	// 0 id, 1 name, 2 amount, 3 period, 4 rule, 5 daynumber, 6 stopmode,  7 maxnumbercycle, 8 status, 9 numberofrun, 
	// 10 datecreate, 11 datelastrun, 12 emailreport, 13 totalcredit, 14 totalcardperform 
	
	write_log("[Number of card found : $nb_card]");
	
	$oneday = 60*60*24;
	
	
	// BROWSE THROUGH THE SERVICES 
	foreach ($result as $myservice){
	
		$totalcardperform = 0;
		$totalcredit = 0;
		$timestamp_lastsend = strtotime($myservice[11]);  // 4 aug 1PM
		$datewish = time()- (intval($myservice[3]) * $oneday) - 1800; //minus 30 min   4 aug 1:29PM
		
		write_log("[Service : ".$myservice[1]." ]");
		
		if ($verbose_level>=1) echo "------>>>   TIME STAMP $datewish < $timestamp_lastsend \n";		

		// Comment if you dont wish to check time of the service running
		// if ($datewish < $timestamp_lastsend){ 	write_log("[Service in the Date range : not to run ]");	continue; }
			
		
		
	
		write_log("[Service analyze cards on which to apply service ]");
		// BROWSE THROUGH THE CARD TO APPLY THE SERVICE 
		for ($page = 0; $page <= $nbpagemax; $page++) {
			
			$sql = "SELECT id, credit, nbservice, lastuse, username FROM cc_card WHERE runservice=1 ORDER BY id  LIMIT ".$groupcard." OFFSET ".$page*$groupcard;
			if ($verbose_level>=1) echo "==> SELECT CARD QUERY : $sql\n";
			$result_card = $instance_table -> SQLExec ($A2B -> DBHandle, $sql);
		
			foreach ($result_card as $mycard){
			
				
				if ($verbose_level>=1) echo "------>>>  ID = ".$mycard[0]." - CARD =".$mycard[4]." - BALANCE =".$mycard[1]." \n";	
				if ( ($myservice[4]==1)  || ($myservice[4]==2) ){
					
					$timestamp_lastuse = strtotime($mycard[3]);  // 4 aug 1PM
					$datewish = time()- (intval($myservice[5]) * $oneday) - 1800; //minus 30 min   4 aug 1:29PM
					
					$temp = $datewish < $timestamp_lastuse;					
					if ($verbose_level>=1) echo "------>>>   TIME STAMP $datewish < $timestamp_lastuse = $temp \n";		
			
					// RULE 1 : "User didnt use card since %nextfield% day(s)"
					if ($verbose_level>=1) echo "RULE 1 : User didnt use card since %nextfield% day(s)\n";
					if ( ($myservice[4]==1) && ($datewish < $timestamp_lastuse) && ($myservice[5]>0) ) {
						if ($verbose_level>=1) echo "#### CARD : card used since ".$myservice[5]." day(s)\n";
						continue;
					}
										
					// RULE 2 : "User use the card in the last %nextfield% day(s)"
					if ($verbose_level>=1) echo "RULE 2 : User use the card in the last %nextfield% day(s)\n";
					if ( ($myservice[4]==2) && ($datewish > $timestamp_lastuse) && ($myservice[5]>0) ) {
						if ($verbose_level>=1) echo "#### CARD : User didnt use the card in the last ".$myservice[5]." day(s)\n";
						continue;
					}					
					
				}// RULE 0 : NO RULES :D
				
				// CHECK if NBSERVICE > MAXNUMBERCYCLE  && STOPMODE Max number of cycle reach
				if ($mycard[2]>$myservice[7] && $myservice[6]==2) continue;
				
				
				// CHECK if CREDIT <= 0 && STOPMODE Account balance below zero
				if ( $mycard[1]<=0 && $myservice[6]==1 ) continue;
				
				
				$QUERY = "UPDATE cc_card SET nbservice=nbservice+1, credit=credit-'".$myservice[2]."' WHERE id=".$mycard[0];	
				$result = $instance_table -> SQLExec ($A2B -> DBHandle, $QUERY, 0);
				if ($verbose_level>=1) echo "==> UPDATE CARD QUERY: 	$QUERY\n";
				$totalcardperform ++;
				$totalcredit += $myservice[2];
				//exit();
			}
			// Little bit of rest
			sleep(15);
		}
	
		write_log("[Service finish]");
		
		// INSERT REPORT SERVICE INTO THE DATABASE
		$QUERY = "INSERT INTO cc_service_report (cc_service_id, totalcardperform, totalcredit) ".
				 "VALUES ('".$myservice[0]."', '$totalcardperform', '$totalcredit')";		
		$result_insert = $instance_table -> SQLExec ($A2B -> DBHandle, $QUERY, 0);
		if ($verbose_level>=1) echo "==> INSERT SERVICE REPORT QUERY=$QUERY\n";
	
		write_log("[Service report : 'totalcardperform=$totalcardperform', 'totalcredit=$totalcredit']");
		
		// UPDATE THE SERVICE		
		$QUERY = "UPDATE cc_service SET datelastrun='now()', numberofrun=numberofrun+1, totalcardperform=totalcardperform+".$totalcardperform.
				 ", totalcredit = totalcredit + '".$totalcredit."' WHERE id=".$myservice[0];	
		$result = $instance_table -> SQLExec ($A2B -> DBHandle, $QUERY, 0);
		if ($verbose_level>=1) echo "==> SERVICE UPDATE QUERY: 	$QUERY\n";
		
		
		// SEND REPORT
		if (strlen($myservice[12])>0){
			$mail_content = "SERVICE NAME = ".$myservice[1];
			$mail_content .= "\n\nTotal card updated = ".$totalcardperform;
			$mail_content .= "\nTotal credit removed = ".$totalcredit;
			mail($myservice[12], "A2BILLING RECURSING SERVICES : REPORT", $mail_content);
		}
	
	} // END FOREACH SERVICES
	
	if ($verbose_level>=1) echo "#### END RECURRING SERVICES \n";
	write_log("[#### BATCH PROCESS END ####]");
	
?>
